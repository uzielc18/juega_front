<nb-card
  accent="primary"
  class="scrollModal"
  [nbSpinner]="loading"
  nbSpinnerStatus="primary"
  nbSpinnerSize="large"
  nbSpinnerMessage="Procesando información"
>
  <nb-card-header style="padding-top: 5px; padding-bottom: 5px">
    <div class="d-flex align-items-center justify-content-between">
      <h5>Nueva Rúbrica</h5>
      <button nbButton outline status="primary" size="tiny" (click)="closeModal()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  </nb-card-header>
  <nb-card-body>
    <form [formGroup]="userForm">
      <div class="row">
        <div class="col-md-8">
          <input
            class="mb-2"
            type="text"
            nbInput
            placeholder="Título de la rubrica"
            fullWidth
            status="primary"
            fieldSize="small"
            formControlName="nombre"
          />
          <textarea
            nbInput
            fullWidth
            placeholder="Descripción de la rubrica"
            status="primary"
            fieldSize="small"
            rows="1"
            formControlName="descripcion"
          ></textarea>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center mb-2">
            <label class="label" style="width: 100px">Criterios: </label>
            <input
              style="width: 100px"
              fieldSize="small"
              type="number"
              fullWidth
              nbInput
              formControlName="num_criterios"
              min="1"
              [readonly]="true"
            />
            <div class="icons d-flex ms-2">
              <button type="button" nbButton size="small" status="basic" (click)="downNumCriterio()">
                <nb-icon icon="minus-outline"></nb-icon>
              </button>
              <button type="button" nbButton size="small" status="primary" (click)="upNumCriterio()">
                <nb-icon icon="plus-outline"></nb-icon>
              </button>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <label class="label" style="width: 100px">Niveles: </label>
            <input
              style="width: 100px"
              fieldSize="small"
              type="number"
              nbInput
              fullWidth
              formControlName="num_niveles"
              min="1"
              max="7"
              [readonly]="true"
            />
            <div class="icons d-flex ms-2">
              <button type="button" nbButton size="small" status="basic" (click)="downNumNivel()">
                <nb-icon icon="minus-outline"></nb-icon>
              </button>
              <button type="button" nbButton size="small" status="primary" (click)="upNumNivel()">
                <nb-icon icon="plus-outline"></nb-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="test mt-2">
        <div formArrayName="criterios" class="border-top" style="min-width: fit-content">
          <div class="d-flex py-2 border-bottom" style="width: fit-content">
            <div
              class="d-flex align-items-center me-2 px-2 border-end border-start"
              style="min-width: 320px; max-width: 320px"
            >
              <div class="fw-bold">Criterios / Niveles</div>
            </div>
            <div class="d-flex border-end">
              <div
                class="me-2"
                style="min-width: 200px; max-width: 200px"
                *ngFor="let title of titles; let idj = index"
              >
                <input
                  [ngStyle]="title ? rubricColors(idj) : {}"
                  type="text"
                  nbInput
                  fullWidth
                  fieldSize="small"
                  placeholder="Nivel {{ idj + 1 }}"
                  [(ngModel)]="title.nombre"
                  [ngModelOptions]="{ standalone: true }"
                />
              </div>
            </div>
          </div>
          <div *ngFor="let group of criterioArray.controls; let i = index" [formGroupName]="i">
            <div class="d-flex pt-2 pb-1 border-bottom" style="max-width: fit-content">
              <div class="me-2 px-2 border-end border-start d-flex" style="min-width: 320px; max-width: 320px">
                <div class="d-flex flex-column justify-content-center me-2 gap-2">
                  <button nbButton size="small" status="primary" (click)="shift(i - 1, i)">
                    <nb-icon icon="arrowhead-up-outline"></nb-icon>
                  </button>
                  <button nbButton size="small" status="basic" (click)="shift(i, i + 1)">
                    <nb-icon icon="arrowhead-down-outline"></nb-icon>
                  </button>
                </div>
                <div>
                  <div class="d-flex">
                    <div class="mb-2" style="width: 75%">
                      <input
                        fieldSize="small"
                        nbInput
                        placeholder="Criterio {{ i + 1 }}"
                        status="primary"
                        type="text"
                        formControlName="titulo"
                        fullWidth
                      />
                    </div>
                    <div class="ms-2" style="width: 25%">
                      <input
                        fieldSize="small"
                        nbInput
                        placeholder="Puntuacion"
                        status="primary"
                        type="number"
                        formControlName="puntuacion"
                        min="0"
                        fullWidth
                      />
                    </div>
                  </div>
                  <div>
                    <textarea
                      nbInput
                      fullWidth
                      placeholder="Descripción"
                      status="primary"
                      fieldSize="small"
                      rows="2"
                      formControlName="descripcion"
                    ></textarea>
                  </div>
                </div>
              </div>
              <div formArrayName="niveles" class="d-flex border-end">
                <div
                  *ngFor="let subgroup of nivelesGroup(group).controls; let idx = index"
                  [formGroupName]="idx"
                  class="me-2"
                  style="min-width: 200px; max-width: 200px"
                >
                  <div class="mb-1">
                    <textarea
                      nbInput
                      fullWidth
                      placeholder="Descripción"
                      fieldSize="small"
                      rows="2"
                      formControlName="descripcion"
                    ></textarea>
                  </div>
                  <div>
                    <input
                      fieldSize="small"
                      nbInput
                      placeholder="Puntuacion"
                      type="number"
                      formControlName="puntuacion"
                      min="0"
                      [max]="group.get('puntuacion')?.value"
                      fullWidth
                    />
                    <div
                      *ngIf="subgroup.get('puntuacion')?.value > group.get('puntuacion')?.value"
                      class="text-danger"
                    >
                      <small>*Max puntuación: {{ group.get('puntuacion')?.value }}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <pre>{{ userForm?.value | json }}</pre>
        <!-- <pre>{{ titles | json }}</pre> -->
      </div>
    </form>
  </nb-card-body>
  <nb-card-footer class="d-flex">
    <button type="button" class="ms-auto" nbButton size="small" (click)="closeModal()">Cancelar</button>
    <button
      type="button"
      class="ms-2"
      nbButton
      size="small"
      status="primary"
      (click)="saveRubrica()"
      [disabled]="!userForm.valid"
    >
      Guardar
    </button>
  </nb-card-footer>
</nb-card>
